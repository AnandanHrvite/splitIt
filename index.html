<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>SplitIt â€“ Trip Expense</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system;
  background:
   linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)),
   url("https://images.pexels.com/photos/1666021/pexels-photo-1666021.jpeg?auto=compress&cs=tinysrgb&w=1600");
  background-size:cover;
}
.header{
  position:sticky;top:0;z-index:10;
  background:rgba(0,0,0,.65);color:#fff;
  padding:12px;display:flex;justify-content:space-between;align-items:center;
}
.card{
  background:rgba(255,255,255,.95);
  margin:12px;padding:14px;border-radius:14px;
}
button{
  padding:10px;border-radius:10px;
  border:none;background:#2e7d32;color:#fff;font-weight:600
}
button.small{padding:6px 10px;font-size:14px}
button.danger{background:#c62828}
button.share{background:#25D366}
.fab{
  position:fixed;bottom:20px;right:20px;
  width:56px;height:56px;border-radius:50%;
  font-size:30px;background:#2e7d32;color:#fff;
  display:flex;align-items:center;justify-content:center;
}
.expense{border-bottom:1px solid #ddd;padding:10px 0}
.badge{font-size:12px;background:#eee;padding:2px 6px;border-radius:6px}
.hidden{display:none}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:50;
}
.modal-box{
  background:#fff;width:90%;max-width:420px;
  border-radius:14px;padding:16px;
}
.modal-actions{display:flex;gap:10px;margin-top:12px}
input,select{
  width:100%;padding:12px;margin-top:8px;
  border-radius:10px;border:1px solid #ccc;font-size:16px
}
.friend-row{display:flex;justify-content:space-between;margin-top:8px}
</style>
</head>

<body>

<div class="header">
  <button id="resetBtn" class="small">ðŸ”„</button>
  <div id="tripTitle">Kerala Falls Trip ðŸŒŠ</div>
  <div>
    <button id="lockBtn" class="small">ðŸ”“</button>
    <button id="friendsBtn" class="small">ðŸ‘¥</button>
  </div>
</div>

<div class="card">
  <h4>Expenses</h4>
  <div id="expenseList"></div>
</div>

<div class="card">
  <h4>Final Settlement</h4>
  <div id="result"></div>
  <button class="share" id="sharePdfBtn">Share PDF</button>
</div>

<div class="fab" id="addBtn">+</div>

<!-- GENERIC MODAL -->
<div class="modal" id="modal">
 <div class="modal-box">
  <h4 id="modalTitle"></h4>
  <div id="modalBody"></div>
  <div class="modal-actions" id="modalActions"></div>
 </div>
</div>

<script>
const { jsPDF } = window.jspdf;
const KEY="splitit_FINAL_LOCKED";
const readOnly=new URLSearchParams(location.search).get("view")==="1";

let friends=["You"];
let expenses=[];
let balances={};
let locked=false;
let tripName="Kerala Falls Trip ðŸŒŠ";
let editIndex=null;

/* ---------- STORAGE ---------- */
function save(){
 localStorage.setItem(KEY,JSON.stringify({friends,expenses,locked,tripName}));
}
(function(){
 const d=localStorage.getItem(KEY);
 if(d){
  const p=JSON.parse(d);
  friends=p.friends||friends;
  expenses=p.expenses||[];
  locked=p.locked||false;
  tripName=p.tripName||tripName;
 }
 tripTitle.innerText=tripName;
 applyMode(); render();
})();

/* ---------- MODAL ---------- */
function showModal(title,body,actions){
 modalTitle.innerText=title;
 modalBody.innerHTML=body;
 modalActions.innerHTML="";
 actions.forEach(a=>{
  const b=document.createElement("button");
  b.textContent=a.text;
  b.className=a.class||"";
  b.onclick=a.onClick;
  modalActions.appendChild(b);
 });
 modal.style.display="flex";
}
function closeModal(){ modal.style.display="none"; }

/* ---------- MODE ---------- */
function applyMode(){
 resetBtn.classList.toggle("hidden",locked||readOnly);
 addBtn.classList.toggle("hidden",locked||readOnly);
 friendsBtn.classList.toggle("hidden",readOnly);
 lockBtn.textContent=locked?"ðŸ”’":"ðŸ”“";
}

/* ---------- FRIENDS ---------- */
friendsBtn.onclick=()=>{
 showModal("Friends",
  `<input id="newFriend" placeholder="Friend name">
   <div id="friendList"></div>`,
  [{text:"Close",class:"danger",onClick:closeModal}]
 );
 renderFriends();
};
function renderFriends(){
 friendList.innerHTML="";
 friends.forEach(f=>{
  friendList.innerHTML+=`
   <div class="friend-row">
    <span>${f}</span>
    <div>
     <button class="small" onclick="editFriend('${f}')">Edit</button>
     <button class="danger small" onclick="deleteFriend('${f}')">Delete</button>
    </div>
   </div>`;
 });
}
function editFriend(name){
 showModal("Edit Friend",
  `<input id="editName" value="${name}">`,
  [
   {text:"Save",onClick:()=>{
     const n=editName.value.trim();
     if(!n)return;
     friends=friends.map(f=>f===name?n:f);
     expenses.forEach(e=>{
      if(e.payer===name)e.payer=n;
      e.part=e.part.map(p=>p===name?n:p);
     });
     save(); closeModal(); render();
   }},
   {text:"Cancel",class:"danger",onClick:closeModal}
  ]
 );
}
function deleteFriend(name){
 if(expenses.some(e=>e.payer===name||e.part.includes(name))){
  showModal("Not allowed","Friend has expenses",[{text:"OK",onClick:closeModal}]);
  return;
 }
 showModal("Delete Friend?",
  `Delete ${name}?`,
  [
   {text:"Delete",class:"danger",onClick:()=>{
     friends=friends.filter(f=>f!==name);
     save(); closeModal(); render();
   }},
   {text:"Cancel",onClick:closeModal}
  ]
 );
}

/* ---------- EXPENSE ---------- */
addBtn.onclick=()=>openExpense();
function openExpense(e,i){
 editIndex=i??null;
 showModal(editIndex===null?"Add Expense":"Edit Expense",
 `
 <input id="desc" placeholder="Description" value="${e?.desc||""}">
 <input id="amt" type="number" placeholder="Amount" value="${e?.amount||""}">
 <select id="payer">${friends.map(f=>`<option ${e?.payer===f?"selected":""}>${f}</option>`)}</select>
 <div>${friends.map(f=>`
   <label><input type="checkbox" class="part" value="${f}" ${!e||e.part.includes(f)?"checked":""}> ${f}</label><br>`).join("")}</div>
 `,
 [
  {text:"Save",onClick:saveExpense},
  {text:"Cancel",class:"danger",onClick:closeModal}
 ]
 );
}
function saveExpense(){
 const part=[...document.querySelectorAll(".part:checked")].map(e=>e.value);
 const obj={
  desc:desc.value,
  amount:Number(amt.value),
  payer:payer.value,
  part
 };
 if(editIndex===null)expenses.push(obj);
 else expenses[editIndex]=obj;
 save(); closeModal(); render(); sharePrompt(obj);
}
function deleteExpense(i){
 showModal("Delete Expense?","Are you sure?",[
  {text:"Delete",class:"danger",onClick:()=>{
    expenses.splice(i,1);save();closeModal();render();
  }},
  {text:"Cancel",onClick:closeModal}
 ]);
}

/* ---------- RENDER ---------- */
function render(){
 expenseList.innerHTML="";
 balances={};friends.forEach(f=>balances[f]=0);
 expenses.forEach((e,i)=>{
  const s=e.amount/e.part.length;
  e.part.forEach(f=>balances[f]-=s);
  balances[e.payer]+=e.amount;
  expenseList.innerHTML+=`
   <div class="expense">
    <b>${e.desc}</b> â‚¹${e.amount}<br>
    ${!locked&&!readOnly?`
     <button class="small" onclick='openExpense(${JSON.stringify(e)},${i})'>Edit</button>
     <button class="danger small" onclick='deleteExpense(${i})'>Delete</button>`:""}
   </div>`;
 });
 result.innerHTML="";
}

/* ---------- SHARE ---------- */
function sharePrompt(e){
 showModal("Share update?",
  `Expense added:<br><b>${e.desc}</b> â‚¹${e.amount}`,
  [
   {text:"Share WhatsApp",onClick:()=>{
     const txt=`New expense: ${e.desc} â‚¹${e.amount}`;
     window.open("https://wa.me/?text="+encodeURIComponent(txt));
     closeModal();
   }},
   {text:"Close",class:"danger",onClick:closeModal}
  ]
 );
}

/* ---------- PDF SHARE ---------- */
sharePdfBtn.onclick=async()=>{
 const pdf=new jsPDF();
 pdf.text(tripName,14,15);
 pdf.autoTable({
  startY:20,
  head:[["Desc","Paid By","Amount","Split"]],
  body:expenses.map(e=>[e.desc,e.payer,e.amount,e.part.join(", ")])
 });
 const blob=pdf.output("blob");
 const file=new File([blob],`${tripName}.pdf`,{type:"application/pdf"});
 if(navigator.canShare && navigator.canShare({files:[file]})){
  await navigator.share({files:[file],title:tripName});
 }else{
  showModal("iPhone note",
   "For direct WhatsApp PDF sharing on iPhone, open this app in Safari.",
   [{text:"OK",onClick:closeModal}]
  );
  pdf.save(`${tripName}.pdf`);
 }
};

/* ---------- OTHERS ---------- */
lockBtn.onclick=()=>{if(readOnly)return;locked=!locked;save();applyMode();};
resetBtn.onclick=()=>showModal("Clear all data?","This will remove everything",[
 {text:"Clear",class:"danger",onClick:()=>{localStorage.clear();location.reload();}},
 {text:"Cancel",onClick:closeModal}
]);
</script>
</body>
</html>
