<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">

<!-- Prevent mobile zoom -->
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>SplitIt – Trip Expense</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system,BlinkMacSystemFont;
  background:#f2f2f7;
  margin:0;
  padding-bottom:130px;
}
.header{
  background:#4CAF50;
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:20px;
  font-weight:600;
}
.card{
  background:#fff;
  margin:12px;
  padding:14px;
  border-radius:14px;
  box-shadow:0 4px 10px rgba(0,0,0,.06);
}
.card h4{margin:0 0 10px}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:8px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ddd;
}
button{
  background:#4CAF50;
  color:#fff;
  border:none;
  font-weight:600;
}
button.danger{background:#e74c3c}
button.whatsapp{background:#25D366}
.expense{
  padding:10px 0;
  border-bottom:1px solid #eee;
}
.expense:last-child{border-bottom:none}
.bottom-bar{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#fff;
  padding:12px;
  box-shadow:0 -4px 10px rgba(0,0,0,.12);
}
.settlement p{margin:6px 0;font-weight:500}
.footer{
  text-align:center;
  font-size:12px;
  color:#777;
}
</style>
</head>

<body>

<div class="header">SplitIt – Trip Expense</div>

<div class="card">
<h4>Add Friend</h4>
<input id="friendName" placeholder="Friend name">
<button onclick="addFriend()">Add Friend</button>
</div>

<div class="card">
<h4>Expenses</h4>
<div id="expenseList"></div>
</div>

<div class="card settlement">
<h4>Final Settlement</h4>
<div id="result"></div>
<button class="whatsapp" onclick="exportPDF()">Export PDF & Share</button>
</div>

<div class="card">
<button class="danger" onclick="hardReset()">Clear Cache & Reset</button>
</div>

<div class="footer">SplitIt v2</div>

<!-- Sticky Bottom Bar -->
<div class="bottom-bar">
<input id="descInput" placeholder="Expense description">
<input id="amountInput" type="number" placeholder="Amount">
<select id="paidBy"></select>
<button onclick="addExpense()">Add Expense</button>
</div>

<script>
const { jsPDF } = window.jspdf;

/* ---------- VERSION RESET (AUTO CACHE CLEAR) ---------- */
const APP_VERSION = "v2";
const VERSION_KEY = "splitit_version";
const DATA_KEY = "splitit_data";

(function versionCheck(){
  const old = localStorage.getItem(VERSION_KEY);
  if (old !== APP_VERSION) {
    localStorage.clear();
    localStorage.setItem(VERSION_KEY, APP_VERSION);
  }
})();

/* ---------- STATE ---------- */
let friends=[], expenses=[], balances={};

/* ---------- LOAD ---------- */
(function(){
 const d=localStorage.getItem(DATA_KEY);
 if(!d)return;
 const p=JSON.parse(d);
 friends=p.friends||[];
 expenses=p.expenses||[];
 recalc();
 updateDropdown();
 renderExpenses();
 showResult();
})();

function save(){
 localStorage.setItem(DATA_KEY,JSON.stringify({friends,expenses}));
}

/* ---------- FRIENDS ---------- */
function addFriend(){
 const n=friendName.value.trim();
 if(!n||friends.includes(n))return;
 friends.push(n);
 updateDropdown();
 save();
 friendName.value='';
}

function updateDropdown(){
 paidBy.innerHTML='';
 friends.forEach(f=>paidBy.innerHTML+=`<option>${f}</option>`);
}

/* ---------- EXPENSE ---------- */
function addExpense(){
 const d=descInput.value;
 const a=Number(amountInput.value);
 const p=paidBy.value;
 if(!a||!p)return;
 expenses.push({desc:d,amount:a,payer:p});
 descInput.value='';
 amountInput.value='';
 recalc(); renderExpenses(); showResult(); save();
}

function deleteExpense(i){
 expenses.splice(i,1);
 recalc(); renderExpenses(); showResult(); save();
}

/* ---------- CALC ---------- */
function recalc(){
 balances={};
 friends.forEach(f=>balances[f]=0);
 expenses.forEach(e=>{
  const s=e.amount/friends.length;
  friends.forEach(f=>balances[f]-=s);
  balances[e.payer]+=e.amount;
 });
}

/* ---------- UI ---------- */
function renderExpenses(){
 expenseList.innerHTML='';
 expenses.forEach((e,i)=>{
  expenseList.innerHTML+=`
  <div class="expense">
    <b>${e.desc}</b>
    ₹${e.amount} • Paid by ${e.payer}
    <button class="danger" onclick="deleteExpense(${i})">Delete</button>
  </div>`;
 });
}

/* ---------- SETTLEMENT ---------- */
function buildSettlement(){
 const cr=[],db=[],out=[];
 for(let n in balances){
  balances[n]>0&&cr.push({n,amt:balances[n]});
  balances[n]<0&&db.push({n,amt:-balances[n]});
 }
 let i=0,j=0;
 while(i<db.length&&j<cr.length){
  const p=Math.min(db[i].amt,cr[j].amt);
  out.push(`${db[i].n} pays ${cr[j].n} ₹${p.toFixed(2)}`);
  db[i].amt-=p; cr[j].amt-=p;
  if(db[i].amt===0)i++;
  if(cr[j].amt===0)j++;
 }
 return out;
}

function showResult(){
 result.innerHTML='';
 buildSettlement().forEach(l=>result.innerHTML+=`<p>${l}</p>`);
}

/* ---------- PDF EXPORT ---------- */
function exportPDF(){
 const pdf=new jsPDF();
 pdf.text("Trip Expense Summary",14,15);
 pdf.autoTable({
  startY:20,
  head:[["Description","Paid By","Amount"]],
  body:expenses.map(e=>[e.desc,e.payer,e.amount])
 });
 let y=pdf.lastAutoTable.finalY+10;
 pdf.text("Final Settlement",14,y);
 buildSettlement().forEach((l,i)=>pdf.text(l,14,y+8+(i*7)));
 pdf.save("trip-expense-summary.pdf");
 setTimeout(()=>window.open("https://wa.me/"),500);
}

/* ---------- HARD RESET ---------- */
function hardReset(){
 if(!confirm("Clear all app data & cache?"))return;
 localStorage.clear();
 location.reload();
}
</script>

</body>
</html>
