<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>SplitIt ‚Äì Kerala Trip Expense</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system;
  margin:0;
  padding-bottom:130px;
  background:
    linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)),
    url("https://images.pexels.com/photos/1666021/pexels-photo-1666021.jpeg?auto=compress&cs=tinysrgb&w=1600"),
    linear-gradient(#1b5e20,#2e7d32);
  background-size:cover;
  background-position:center;
  background-attachment:fixed;
}

/* HEADER */
.header{
  position:sticky;
  top:0;
  z-index:10;
  background:rgba(0,0,0,.6);
  color:#fff;
  padding:14px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}

/* HEADER BUTTONS */
.header-left button,
.header-right button{
  background:none;
  border:none;
  color:#fff;
  font-size:18px;
  cursor:pointer;
}
.header-title{
  font-size:18px;
  font-weight:600;
}

/* CARDS */
.card{
  background:rgba(255,255,255,.9);
  margin:12px;
  padding:14px;
  border-radius:14px;
}

input,select,button{
  width:100%;
  padding:14px;
  margin-top:8px;
  font-size:16px;
  border-radius:10px;
  border:1px solid #ccc;
}

button{
  background:#2e7d32;
  color:#fff;
  border:none;
  font-weight:600;
}
button.danger{background:#c62828}
button.small{width:auto;padding:6px 12px;font-size:14px}
button.share{background:#25D366}

.expense{
  padding:10px 0;
  border-bottom:1px solid #ddd;
}
.expense:last-child{border-bottom:none}

/* BOTTOM BAR */
.bottom-bar{
  position:fixed;
  bottom:0;left:0;right:0;
  background:#fff;
  padding:12px;
  box-shadow:0 -4px 10px rgba(0,0,0,.3);
}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.5);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.modal-content{
  background:#fff;
  width:90%;
  max-width:400px;
  padding:16px;
  border-radius:12px;
}
.friend-row{
  display:flex;
  gap:6px;
  align-items:center;
  margin-top:8px;
}
.friend-row span{flex:1}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <button title="Clear all data" onclick="confirmReset()">üîÑ</button>
  </div>
  <div class="header-title">SplitIt ‚Äì Kerala Falls üåä</div>
  <div class="header-right">
    <button title="Manage friends" onclick="openFriendModal()">üë•</button>
  </div>
</div>

<div class="card">
  <h4>Expenses</h4>
  <div id="expenseList"></div>
</div>

<div class="card">
  <h4>Final Settlement</h4>
  <div id="result"></div>
  <button class="share" onclick="exportAndSharePDF()">Export PDF & Share</button>
</div>

<!-- ADD EXPENSE -->
<div class="bottom-bar">
  <input id="descInput" placeholder="Expense description">
  <input id="amountInput" type="number" placeholder="Amount">
  <select id="paidBy"></select>
  <button onclick="addExpense()">Add Expense</button>
</div>

<!-- FRIEND MODAL -->
<div class="modal" id="friendModal">
  <div class="modal-content">
    <h4>Manage Friends</h4>
    <input id="newFriend" placeholder="Friend name">
    <button onclick="addFriend()">Add Friend</button>
    <div id="friendList"></div>
    <button class="danger" onclick="closeFriendModal()">Close</button>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
const KEY="splitit_single";

let friends=[], expenses=[], balances={};

/* LOAD */
(function(){
 const d=localStorage.getItem(KEY);
 if(!d)return;
 const p=JSON.parse(d);
 friends=p.friends||[];
 expenses=p.expenses||[];
 recalc(); updateDropdown(); renderExpenses(); showResult();
})();

function save(){localStorage.setItem(KEY,JSON.stringify({friends,expenses}))}

/* FRIENDS */
function openFriendModal(){
 renderFriends();
 friendModal.style.display="flex";
}
function closeFriendModal(){ friendModal.style.display="none"; }

function addFriend(){
 const n=newFriend.value.trim();
 if(!n||friends.includes(n))return;
 friends.push(n);
 newFriend.value='';
 updateDropdown(); save(); renderFriends();
}

function editFriend(oldName){
 const newName=prompt("Edit friend name",oldName);
 if(!newName||friends.includes(newName))return;
 friends=friends.map(f=>f===oldName?newName:f);
 expenses.forEach(e=>{if(e.payer===oldName)e.payer=newName});
 recalc(); updateDropdown(); renderExpenses(); showResult(); save(); renderFriends();
}

function removeFriend(name){
 if(expenses.some(e=>e.payer===name)){
  alert("Cannot delete. This friend has expenses.");
  return;
 }
 friends=friends.filter(f=>f!==name);
 updateDropdown(); save(); renderFriends();
}

function renderFriends(){
 friendList.innerHTML='';
 friends.forEach(f=>{
  friendList.innerHTML+=`
   <div class="friend-row">
    <span>${f}</span>
    <button class="small" onclick="editFriend('${f}')">Edit</button>
    <button class="danger small" onclick="removeFriend('${f}')">Delete</button>
   </div>`;
 });
}

function updateDropdown(){
 paidBy.innerHTML='';
 friends.forEach(f=>paidBy.innerHTML+=`<option>${f}</option>`);
}

/* EXPENSES */
function addExpense(){
 const d=descInput.value;
 const a=Number(amountInput.value);
 const p=paidBy.value;
 if(!a||!p)return;
 expenses.push({desc:d,amount:a,payer:p});
 descInput.value=''; amountInput.value='';
 recalc(); renderExpenses(); showResult(); save();
}

function deleteExpense(i){
 expenses.splice(i,1);
 recalc(); renderExpenses(); showResult(); save();
}

function renderExpenses(){
 expenseList.innerHTML='';
 expenses.forEach((e,i)=>{
  expenseList.innerHTML+=`
   <div class="expense">
    <b>${e.desc}</b>
    ‚Çπ${e.amount} ‚Ä¢ Paid by ${e.payer}
    <button class="danger small" onclick="deleteExpense(${i})">Delete</button>
   </div>`;
 });
}

/* CALC */
function recalc(){
 balances={}; friends.forEach(f=>balances[f]=0);
 expenses.forEach(e=>{
  const s=e.amount/friends.length;
  friends.forEach(f=>balances[f]-=s);
  balances[e.payer]+=e.amount;
 });
}

function buildSettlement(){
 const cr=[],db=[],out=[];
 for(let n in balances){
  balances[n]>0&&cr.push({n,amt:balances[n]});
  balances[n]<0&&db.push({n,amt:-balances[n]});
 }
 let i=0,j=0;
 while(i<db.length&&j<cr.length){
  const p=Math.min(db[i].amt,cr[j].amt);
  out.push(`${db[i].n} pays ${cr[j].n} ‚Çπ${p.toFixed(2)}`);
  db[i].amt-=p; cr[j].amt-=p;
  if(db[i].amt===0)i++;
  if(cr[j].amt===0)j++;
 }
 return out;
}

function showResult(){
 result.innerHTML='';
 buildSettlement().forEach(l=>result.innerHTML+=`<p>${l}</p>`);
}

/* PDF */
async function exportAndSharePDF(){
 const pdf=new jsPDF();
 pdf.text("Kerala Falls Trip Expense Summary",14,15);
 pdf.autoTable({
  startY:20,
  head:[["Description","Paid By","Amount"]],
  body:expenses.map(e=>[e.desc,e.payer,e.amount])
 });
 let y=pdf.lastAutoTable.finalY+10;
 pdf.text("Final Settlement",14,y);
 buildSettlement().forEach((l,i)=>pdf.text(l,14,y+8+(i*7)));

 const blob=pdf.output("blob");
 const file=new File([blob],"kerala-trip.pdf",{type:"application/pdf"});
 if(navigator.canShare&&navigator.canShare({files:[file]})){
  await navigator.share({files:[file]});
 }else{
  pdf.save("kerala-trip.pdf");
 }
}

/* CLEAR ALL ‚Äì CONFIRM */
function confirmReset(){
 if(confirm("‚ö†Ô∏è This will DELETE all friends & expenses.\nAre you sure?")){
  localStorage.clear();
  location.reload();
 }
}
</script>

</body>
</html>
