<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>SplitIt â€“ Trip Expense</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  font-family:system-ui,-apple-system;
  margin:0;padding-bottom:40px;
  background:
    linear-gradient(rgba(0,0,0,.35), rgba(0,0,0,.35)),
    url("https://images.pexels.com/photos/1666021/pexels-photo-1666021.jpeg?auto=compress&cs=tinysrgb&w=1600"),
    linear-gradient(#1b5e20,#2e7d32);
  background-size:cover;
}
.header{
  position:sticky;top:0;z-index:10;
  background:rgba(0,0,0,.65);color:#fff;
  padding:12px 14px;
  display:flex;justify-content:space-between;align-items:center;
}
.header-title{font-size:18px;font-weight:600;cursor:pointer}
.card{
  background:rgba(255,255,255,.92);
  margin:12px;padding:14px;border-radius:14px;
}
.expense{padding:10px 0;border-bottom:1px solid #ddd}
.expense:last-child{border-bottom:none}
.badge{font-size:12px;background:#eee;padding:2px 6px;border-radius:6px}

button{
  background:#2e7d32;color:#fff;border:none;
  padding:10px;border-radius:10px;font-size:15px;font-weight:600;
}
button.small{padding:6px 10px;font-size:14px}
button.danger{background:#c62828}
button.share{background:#25D366}
button.disabled{background:#aaa}

.fab{
  position:fixed;bottom:20px;right:20px;
  width:56px;height:56px;border-radius:50%;
  background:#2e7d32;color:#fff;
  font-size:32px;display:flex;
  align-items:center;justify-content:center;
  box-shadow:0 6px 15px rgba(0,0,0,.4);
  z-index:15;
}

.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.5);
  display:none;align-items:flex-end;
  justify-content:center;z-index:20;
}
.modal-content{
  background:#fff;width:100%;
  max-height:90%;
  padding:16px;border-radius:16px 16px 0 0;
  overflow:auto;
}

input,select{
  width:100%;padding:14px;margin-top:8px;
  font-size:16px;border-radius:10px;border:1px solid #ccc;
}

.friend-row{
  display:flex;justify-content:space-between;align-items:center;
  margin-top:8px;
}
.friend-chip{display:inline-block;margin:6px 8px 0 0}

.lock{font-size:18px;cursor:pointer}
.hidden{display:none}
</style>
</head>

<body>

<div class="header">
  <button id="resetBtn" class="small" onclick="resetAll()">ðŸ”„</button>
  <div class="header-title" onclick="renameTrip()" id="tripTitle">Kerala Falls Trip ðŸŒŠ</div>
  <div>
    <span class="lock" id="lockIcon" onclick="toggleLock()">ðŸ”“</span>
    <button id="friendsBtn" class="small" onclick="openFriends()">ðŸ‘¥</button>
  </div>
</div>

<div class="card">
  <h4>Expenses</h4>
  <div id="expenseList"></div>
</div>

<div class="card">
  <h4>Final Settlement</h4>
  <div id="result"></div>
  <button class="share" onclick="exportPDF()">Export PDF</button>
</div>

<div class="fab" id="addFab" onclick="openAdd()">+</div>

<!-- ADD / EDIT EXPENSE -->
<div class="modal" id="expenseModal">
  <div class="modal-content">
    <h4 id="expenseTitle">Add Expense</h4>
    <input id="descInput" placeholder="Description">
    <input id="amountInput" type="number" placeholder="Amount">
    <select id="category">
      <option>Food</option><option>Travel</option>
      <option>Stay</option><option>Fuel</option><option>Misc</option>
    </select>
    <div id="participants"></div>
    <select id="paidBy"></select>
    <button onclick="saveExpense()">Save</button>
    <button class="danger" onclick="closeExpense()">Cancel</button>
  </div>
</div>

<!-- FRIENDS MODAL -->
<div class="modal" id="friendsModal">
  <div class="modal-content">
    <h4>Friends</h4>
    <input id="newFriend" placeholder="Friend name">
    <button onclick="addFriend()">Add Friend</button>
    <div id="friendList"></div>
    <button class="danger" onclick="closeFriends()">Close</button>
  </div>
</div>

<script>
const { jsPDF } = window.jspdf;
const KEY="splitit_full_final";
const readOnly=new URLSearchParams(location.search).get("view")==="1";

let friends=["You"], expenses=[], balances={};
let tripName="Kerala Falls Trip ðŸŒŠ";
let locked=false, editIndex=null;

/* LOAD */
(function(){
 const d=localStorage.getItem(KEY);
 if(d){
  const p=JSON.parse(d);
  friends=p.friends||friends;
  expenses=p.expenses||[];
  tripName=p.tripName||tripName;
  locked=p.locked||false;
 }
 tripTitle.innerText=tripName;
 applyMode();
 recalc(); renderAll();
})();

function save(){
 localStorage.setItem(KEY,JSON.stringify({friends,expenses,tripName,locked}));
}

/* MODE */
function applyMode(){
 lockIcon.innerText=locked?"ðŸ”’":"ðŸ”“";
 resetBtn.classList.toggle("hidden", locked||readOnly);
 addFab.classList.toggle("hidden", locked||readOnly);
 friendsBtn.classList.toggle("hidden", readOnly);
}

/* FRIENDS */
function openFriends(){ friendsModal.style.display="flex"; renderFriends(); }
function closeFriends(){ friendsModal.style.display="none"; }

function addFriend(){
 const n=newFriend.value.trim();
 if(!n||friends.includes(n))return;
 friends.push(n); newFriend.value="";
 updateParticipants(); renderFriends(); save();
}
function editFriend(oldName){
 const n=prompt("Edit name",oldName);
 if(!n||friends.includes(n))return;
 friends=friends.map(f=>f===oldName?n:f);
 expenses.forEach(e=>{
  if(e.payer===oldName)e.payer=n;
  e.part=e.part.map(p=>p===oldName?n:p);
 });
 updateParticipants(); recalc(); renderAll(); save();
}
function deleteFriend(name){
 if(expenses.some(e=>e.payer===name||e.part.includes(name))){
  alert("Cannot delete friend with expenses");
  return;
 }
 friends=friends.filter(f=>f!==name);
 updateParticipants(); renderFriends(); save();
}
function renderFriends(){
 friendList.innerHTML="";
 friends.forEach(f=>{
  friendList.innerHTML+=`
   <div class="friend-row">
    <span>${f}</span>
    <div>
     <button class="small" onclick="editFriend('${f}')">Edit</button>
     <button class="danger small" onclick="deleteFriend('${f}')">Delete</button>
    </div>
   </div>`;
 });
}

/* EXPENSE */
function openAdd(){
 editIndex=null;
 expenseTitle.innerText="Add Expense";
 descInput.value=""; amountInput.value="";
 expenseModal.style.display="flex";
}
function openEdit(i){
 if(locked||readOnly)return;
 const e=expenses[i];
 editIndex=i;
 expenseTitle.innerText="Edit Expense";
 descInput.value=e.desc;
 amountInput.value=e.amount;
 category.value=e.cat;
 paidBy.value=e.payer;
 document.querySelectorAll("input[name=part]").forEach(cb=>{
  cb.checked=e.part.includes(cb.value);
 });
 expenseModal.style.display="flex";
}
function closeExpense(){ expenseModal.style.display="none"; }

function saveExpense(){
 const d=descInput.value;
 const a=Number(amountInput.value);
 const p=paidBy.value;
 const c=category.value;
 const part=[...document.querySelectorAll("input[name=part]:checked")].map(e=>e.value);
 if(!a||!p||!part.length)return;
 const obj={desc:d,amount:a,payer:p,cat:c,part};
 if(editIndex!==null) expenses[editIndex]=obj;
 else expenses.push(obj);
 closeExpense(); recalc(); renderAll(); save();
}

/* UI */
function updateParticipants(){
 paidBy.innerHTML=""; participants.innerHTML="";
 friends.forEach(f=>{
  paidBy.innerHTML+=`<option>${f}</option>`;
  participants.innerHTML+=`
   <label class="friend-chip">
    <input type="checkbox" name="part" value="${f}" checked> ${f}
   </label>`;
 });
}
updateParticipants();

/* CALC */
function recalc(){
 balances={}; friends.forEach(f=>balances[f]=0);
 expenses.forEach(e=>{
  const s=e.amount/e.part.length;
  e.part.forEach(f=>balances[f]-=s);
  balances[e.payer]+=e.amount;
 });
}

/* RENDER */
function renderAll(){
 expenseList.innerHTML="";
 expenses.forEach((e,i)=>{
  expenseList.innerHTML+=`
   <div class="expense">
    <b>${e.desc}</b> <span class="badge">${e.cat}</span><br>
    â‚¹${e.amount} â€¢ ${e.payer}<br>
    Split: ${e.part.join(", ")}<br>
    ${(!locked&&!readOnly)?`
     <button class="small" onclick="openEdit(${i})">Edit</button>
     <button class="danger small" onclick="deleteExpense(${i})">Delete</button>
    `:""}
   </div>`;
 });
 renderSettlement();
}
function deleteExpense(i){
 if(locked||readOnly)return;
 if(!confirm("Delete this expense?"))return;
 expenses.splice(i,1); recalc(); renderAll(); save();
}
function renderSettlement(){
 result.innerHTML="";
 const cr=[],db=[];
 for(let n in balances){
  balances[n]>0&&cr.push({n,amt:balances[n]});
  balances[n]<0&&db.push({n,amt:-balances[n]});
 }
 let i=0,j=0;
 while(i<db.length&&j<cr.length){
  const p=Math.min(db[i].amt,cr[j].amt);
  result.innerHTML+=`<p>${db[i].n} pays ${cr[j].n} â‚¹${p.toFixed(2)}</p>`;
  db[i].amt-=p; cr[j].amt-=p;
  if(db[i].amt===0)i++; if(cr[j].amt===0)j++;
 }
}

/* UTILS */
function toggleLock(){ if(readOnly)return; locked=!locked; save(); applyMode(); }
function renameTrip(){
 if(readOnly)return;
 const n=prompt("Rename trip",tripName);
 if(n){tripName=n;tripTitle.innerText=n;save();}
}
function resetAll(){
 if(confirm("Clear all data?")){
  localStorage.clear(); location.reload();
 }
}
function exportPDF(){
 const pdf=new jsPDF();
 pdf.text(tripName,14,15);
 pdf.autoTable({
  startY:20,
  head:[["Desc","Cat","Paid","Amount","Split"]],
  body:expenses.map(e=>[e.desc,e.cat,e.payer,e.amount,e.part.join(", ")])
 });
 pdf.save(tripName+".pdf");
}
</script>

</body>
</html>
