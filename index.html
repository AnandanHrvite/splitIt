<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>SplitIt â€“ Trip Expense</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;font-family:system-ui,-apple-system;
  background:
   linear-gradient(rgba(0,0,0,.35),rgba(0,0,0,.35)),
   url("https://images.pexels.com/photos/1666021/pexels-photo-1666021.jpeg?auto=compress&cs=tinysrgb&w=1600");
  background-size:cover;
}
.header{
  position:sticky;top:0;z-index:10;
  background:rgba(0,0,0,.65);color:#fff;
  padding:12px;display:flex;justify-content:space-between;align-items:center;
}
.card{
  background:rgba(255,255,255,.95);
  margin:12px;padding:14px;border-radius:14px;
}
button{
  padding:10px;border-radius:10px;
  border:none;background:#2e7d32;color:#fff;font-weight:600
}
button.small{padding:6px 10px;font-size:14px}
button.danger{background:#c62828}
button.share{background:#25D366}
.hidden{display:none}
.fab{
  position:fixed;bottom:20px;right:20px;
  width:56px;height:56px;border-radius:50%;
  font-size:30px;background:#2e7d32;color:#fff;
  display:flex;align-items:center;justify-content:center;
}
.expense{border-bottom:1px solid #ddd;padding:10px 0}
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.6);
  display:none;align-items:center;justify-content:center;z-index:50;
}
.modal-box{
  background:#fff;width:90%;max-width:420px;
  padding:16px;border-radius:14px
}
input,select{
  width:100%;padding:12px;margin-top:8px;
  border-radius:10px;border:1px solid #ccc;font-size:16px
}
.friend-row{display:flex;justify-content:space-between;margin-top:8px}
</style>
</head>

<body>

<div class="header">
  <button id="resetBtn" class="small">ðŸ”„</button>
  <div>SplitIt</div>
  <div>
    <button id="lockBtn" class="small">ðŸ”“</button>
    <button id="friendsBtn" class="small">ðŸ‘¥</button>
  </div>
</div>

<div class="card">
 <h4>Expenses</h4>
 <div id="expenseList"></div>
</div>

<div class="card">
 <h4>Final Settlement</h4>
 <div id="result"></div>
 <button class="share" onclick="exportPDF()">Export PDF</button>
</div>

<div class="fab" id="addBtn">+</div>

<div class="modal" id="modal">
 <div class="modal-box">
  <div id="modalBody"></div>
 </div>
</div>

<script>
const { jsPDF } = window.jspdf;

let friends=[];          // âŒ no default "You"
let expenses=[];
let balances={};
let locked=false;
const modal=document.getElementById("modal");

/* STORAGE */
function save(){
 localStorage.setItem("splitit_lock",JSON.stringify({friends,expenses,locked}));
}
(function(){
 const d=localStorage.getItem("splitit_lock");
 if(d){
  const p=JSON.parse(d);
  friends=p.friends||[];
  expenses=p.expenses||[];
  locked=p.locked||false;
 }
 updateMode(); render();
})();

/* MODAL */
function show(html){ modalBody.innerHTML=html; modal.style.display="flex"; }
function closeModal(){ modal.style.display="none"; }

/* MODE */
function updateMode(){
 lockBtn.textContent=locked?"ðŸ”’":"ðŸ”“";
 addBtn.classList.toggle("hidden",locked);
 resetBtn.classList.toggle("hidden",locked);
}

/* FRIENDS */
friendsBtn.onclick=()=>{
 if(locked) return;
 show(`
  <h4>Friends</h4>
  <input id="fname" placeholder="Friend name">
  <button onclick="addFriend()">Add Friend</button>
  ${friends.map(f=>`
   <div class="friend-row">
    <span>${f}</span>
    <button class="danger small" onclick="removeFriend('${f}')">Delete</button>
   </div>`).join("")}
  <button class="danger" onclick="closeModal()">Close</button>
 `);
};

function addFriend(){
 const n=fname.value.trim();
 if(!n||friends.includes(n))return;
 friends.push(n);
 save(); closeModal(); render();
}

function removeFriend(f){
 if(expenses.some(e=>e.payer===f||e.part.includes(f))){
  show("<p>Friend used in expenses</p><button onclick='closeModal()'>OK</button>");
  return;
 }
 friends=friends.filter(x=>x!==f);
 save(); closeModal(); render();
}

/* EXPENSE */
addBtn.onclick=()=>{
 if(locked) return;
 if(!friends.length){
  show("<p>Add friends before adding expenses</p><button onclick='closeModal()'>OK</button>");
  return;
 }
 openExpense();
};

function openExpense(e,i){
 show(`
  <h4>${e?"Edit":"Add"} Expense</h4>
  <input id="desc" placeholder="Description" value="${e?.desc||""}">
  <input id="amt" type="number" placeholder="Amount" value="${e?.amount||""}">
  <select id="payer">${friends.map(f=>`<option ${e?.payer===f?"selected":""}>${f}</option>`).join("")}</select>
  ${friends.map(f=>`
   <label>
    <input type="checkbox" class="part" value="${f}" ${!e||e.part.includes(f)?"checked":""}>
    ${f}
   </label><br>`).join("")}
  <button onclick="saveExpense(${i??"null"})">Save</button>
  <button class="danger" onclick="closeModal()">Cancel</button>
 `);
}

function saveExpense(i){
 const part=[...document.querySelectorAll(".part:checked")].map(e=>e.value);
 if(!part.length) return;
 const obj={desc:desc.value,amount:Number(amt.value),payer:payer.value,part};
 if(i==null) expenses.push(obj);
 else expenses[i]=obj;
 save(); closeModal(); render();
}

function deleteExpense(i){
 if(locked) return;
 show(`
  <p>Delete expense?</p>
  <button class="danger" onclick="confirmDelete(${i})">Delete</button>
  <button onclick="closeModal()">Cancel</button>
 `);
}
function confirmDelete(i){
 expenses.splice(i,1);
 save(); closeModal(); render();
}

/* RENDER */
function render(){
 expenseList.innerHTML="";
 balances={}; friends.forEach(f=>balances[f]=0);

 expenses.forEach((e,i)=>{
  const share=e.amount/e.part.length;
  e.part.forEach(f=>balances[f]-=share);
  balances[e.payer]+=e.amount;

  expenseList.innerHTML+=`
   <div class="expense">
    <b>${e.desc}</b> â‚¹${e.amount}<br>
    Paid by ${e.payer}<br>
    ${!locked?`
     <button class="small" onclick="openExpense(expenses[${i}],${i})">Edit</button>
     <button class="danger small" onclick="deleteExpense(${i})">Delete</button>`:""}
   </div>`;
 });
 renderSettlement();
}

function renderSettlement(){
 result.innerHTML="";
 const d=[],c=[];
 for(const f in balances){
  if(balances[f]<0)d.push({f,amt:-balances[f]});
  if(balances[f]>0)c.push({f,amt:balances[f]});
 }
 let i=0,j=0;
 while(i<d.length&&j<c.length){
  const x=Math.min(d[i].amt,c[j].amt);
  result.innerHTML+=`<div>${d[i].f} pays ${c[j].f} â‚¹${x.toFixed(2)}</div>`;
  d[i].amt-=x; c[j].amt-=x;
  if(d[i].amt===0)i++;
  if(c[j].amt===0)j++;
 }
 if(!result.innerHTML) result.innerHTML="<i>No settlement needed</i>";
}

/* PDF */
function exportPDF(){
 const pdf=new jsPDF();
 pdf.text("Trip Expenses",14,15);
 pdf.autoTable({
  startY:20,
  head:[["Desc","Paid By","Amount","Split"]],
  body:expenses.map(e=>[e.desc,e.payer,e.amount,e.part.join(", ")])
 });
 pdf.save("splitit.pdf");
}

/* LOCK + RESET */
lockBtn.onclick=()=>{ locked=!locked; save(); updateMode(); };
resetBtn.onclick=()=>{
 show(`
  <p>Clear all data?</p>
  <button class="danger" onclick="localStorage.clear();location.reload()">Clear</button>
  <button onclick="closeModal()">Cancel</button>
 `);
};
</script>
</body>
</html>
